name: RunTests

# Connected workflows are:
# 1. ðŸ“RunTests - run_tests.yml
# 2. CreateReleasePR - create_release_pr.yml
# 3. MergeAndRelease - merge_and_release.yml

# checks code of a PR as a precondition for merges

permissions:
  contents: write
  pull-requests: write
on:
  # Test PRs generated by actions
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
      sha:
        required: true
        type: string
      version:
        required: true
        type: string
  # Test PRs and commits to PRs from users
  pull_request_target:
    branches: [main]
    types: [opened, synchronize]

jobs:
  run_tests:
    if: (github.event_name != 'workflow_call') || (github.event_name == 'workflow_call' && startsWith(github.event.inputs.branch, 'release/'))
    runs-on: windows-latest

    steps:
      - name: Get PR sha
        id: get_sha
        run: |
          if('${{ github.event_name }}' -eq 'workflow_call') {
            $PR_SHA = '${{ github.event.inputs.sha }}'
          } else {
            $PR_SHA = '${{ github.event.pull_request.head.sha }}'
          }
          Write-Output "PR_SHA=$PR_SHA" >> $env:GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ steps.get_sha.outputs.PR_SHA }}
      - run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@users.noreply.github.com"

      - name: Run Tests
        shell: pwsh
        id: testresults
        run: |
          Set-PSRepository psgallery -InstallationPolicy trusted
          Install-Module -Name Pester -Confirm:$false -Force
          Invoke-Pester

  # Run merge workflow if it was an automated release PR
  trigger_merge:
    if: (github.event_name == 'workflow_call' && startsWith(github.event.inputs.branch, 'release/'))
    needs: [run_tests]
    uses: ./.github/workflows/merge_and_release.yml
    with:
      sha: ${{ github.event.inputs.sha }}
      branch: ${{ github.event.inputs.branch }}
      version: ${{ github.event.inputs.version }}
